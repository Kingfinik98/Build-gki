name: Build BoltX-Oss Kernel 5.10 (SM7435 - Garnet)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # Branding kernel
      KERNEL_NAME: "BoltX-Oss"
      
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          # Menggunakan repository fork Anda
          repository: Kingfinik98/android_kernel_xiaomi_garnet
          ref: lineage-23.0
          submodules: recursive
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev git curl \
          python3 python3-pip lld zip unzip libncurses5-dev \
          libelf-dev zlib1g-dev dwarves

      - name: Setup Toolchain (Clang 19)
        run: |
          mkdir -p toolchain/clang
          CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main-kernel-2025/clang-r536225.tar.gz"
          echo "Downloading Clang 19..."
          curl -L "${CLANG_URL}" | tar -xz -C toolchain/clang
          
      - name: Prepare & Configure Kernel
        run: |
          # Set Path dan Environment
          export PATH="$(pwd)/toolchain/clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export LLVM=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          
          echo "üîß Menggunakan defconfig yang benar: vendor/garnet_GKI.config"
          make O=out ARCH=arm64 LLVM=1 vendor/garnet_GKI.config
          
          echo "üîß Menerapkan branding kernel..."
          scripts/config --file out/.config --set-str LOCALVERSION "-${KERNEL_NAME}"
          
          echo "üîß Menonaktifkan System Trusted Keys untuk mencegah error..."
          scripts/config --file out/.config --set-str SYSTEM_TRUSTED_KEYS ""
          scripts/config --file out/.config -d SYSTEM_REVOCATION_KEYS
          
          echo "‚úÖ Konfigurasi kernel selesai."

      # LANGKAH KRUSIAL YANG DITAMBAHKAN KEMBALI
      - name: Fix Driver Compilation Errors
        run: |
          echo "üî® Memperbaiki bug yang ada di repository untuk kompatibilitas Clang 19..."
          
          # 1. Perbaiki error 'void function should not return a value' di driver MMC
          echo "  -> Memperbaiki sdhci-msm.c (baris 2872)..."
          # Mengganti 'return 0;' dengan 'return;' pada fungsi bertipe void
          sed -i '2872s/return 0;/return;/' drivers/mmc/host/sdhci-msm.c
          
          # 2. Perbaiki error syntax dan #endif di driver thermal
          echo "  -> Memperbaiki thermal_zone_internal.h..."
          # Membungkus kode yang menggunakan Vendor Hooks dengan #ifdef
          sed -i '/#include <trace\/hooks\/thermal.h>/i\
          \
          #ifdef CONFIG_ANDROID_VENDOR_HOOKS' drivers/thermal/qcom/thermal_zone_internal.h
          sed -i '/unregister_trace_android_vh_disable_thermal_cooling_stats(/a\
          #endif // CONFIG_ANDROID_VENDOR_HOOKS' drivers/thermal/qcom/thermal_zone_internal.h
          
          echo "‚úÖ Semua driver error telah diperbaiki."

      - name: Build Kernel Image & DTB
        run: |
          # Set Path dan Environment
          export PATH="$(pwd)/toolchain/clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export LLVM=1
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          
          echo "üöÄ [1/2] Building kernel Image..."
          make -j"$(nproc --all)" O=out LLVM=1 CLANG_TRIPLE=$CLANG_TRIPLE CROSS_COMPILE=$CROSS_COMPILE Image
          
          echo "üöÄ [2/2] Building DTB..."
          make -j"$(nproc --all)" O=out LLVM=1 CLANG_TRIPLE=$CLANG_TRIPLE CROSS_COMPILE=$CROSS_COMPILE dtbs
          
      - name: Check Kernel Version
        run: |
          echo "‚ÑπÔ∏è Kernel version info:"
          strings out/arch/arm64/boot/Image | grep "Linux version" | head -n 1

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_NAME }}-5.10-garnet-Image
          path: out/arch/arm64/boot/Image
          compression-level: 9
          
      - name: Upload DTB
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_NAME }}-5.10-garnet-DTB
          path: out/arch/arm64/boot/dts/qcom/
          if-no-files-found: warn
          
      - name: Create AnyKernel3 Flashable Zip
        run: |
          echo "üì¶ Membuat flashable zip AnyKernel3..."
          git clone https://github.com/osm0sis/AnyKernel3.git -b master AnyKernel3
          
          # Salin Image
          cp out/arch/arm64/boot/Image AnyKernel3/
          
          # Salin semua DTB
          mkdir -p AnyKernel3/dtbs
          find out/arch/arm64/boot/dts/qcom/ -name "*.dtb" -exec cp {} AnyKernel3/dtbs/ \;
          
          # Buat zip
          cd AnyKernel3
          zip -r9 ../${{ env.KERNEL_NAME }}-5.10-garnet.zip *
          cd ..
          echo "‚úÖ Flashable zip berhasil dibuat: ${{ env.KERNEL_NAME }}-5.10-garnet.zip"
          
      - name: Upload AnyKernel3 Flashable Zip
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.KERNEL_NAME }}-5.10-garnet-Flashable
          path: ${{ env.KERNEL_NAME }}-5.10-garnet.zip
          compression-level: 0
